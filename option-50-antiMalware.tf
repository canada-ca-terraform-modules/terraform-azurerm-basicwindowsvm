/*
Example:

antimalware" {
  RealtimeProtectionEnabled      = "true"
  ScheduledScanSettingsIsEnabled = "false"
  ScheduledScanSettingsDay       = "7"
  ScheduledScanSettingsTime      = "120"
  ScheduledScanSettingsScanType  = "Quick"
  ExclusionsExtensions           = ""
  ExclusionsPaths                = ""
  ExclusionsProcesses            = ""
}

*/

variable "antimalware" {
  description = "Should the VM run antimalware"
  default     = null
}

resource "azurerm_virtual_machine_extension" "IaaSAntimalware" {

  count                      = var.antimalware == null ? 0 : 1
  name                       = "IaaSAntimalware"
  depends_on                 = [azurerm_virtual_machine_extension.MicrosoftMonitoringAgent]
  location                   = var.location
  resource_group_name        = var.resource_group_name
  virtual_machine_name       = azurerm_virtual_machine.VM.name
  publisher                  = "Microsoft.Azure.Security"
  type                       = "IaaSAntimalware"
  type_handler_version       = "1.5"
  auto_upgrade_minor_version = true

  settings = <<SETTINGS
        {  
          "AntimalwareEnabled": true,
          "RealtimeProtectionEnabled": "${var.antimalware.RealtimeProtectionEnabled}",
          "ScheduledScanSettings": {
            "isEnabled": "${var.antimalware.ScheduledScanSettingsIsEnabled}",
            "day": "${var.antimalware.ScheduledScanSettingsDay}",
            "time": "${var.antimalware.ScheduledScanSettingsTime}",
            "scanType": "${var.antimalware.ScheduledScanSettingsScanType}"
          },
          "Exclusions": {
            "Extensions": "${var.antimalware.ExclusionsExtensions}",
            "Paths": "${var.antimalware.ExclusionsPaths}",
            "Processes": "${var.antimalware.ExclusionsProcesses}"
          }
        }
  SETTINGS

  tags = var.tags
}
